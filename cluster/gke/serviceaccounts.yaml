# This file describes all the workload identities and there respective
# namespaces
# 
# Creating k8s namespaces from terraform feels like a layering violation.
# However, the 'canned' workload identity support needs to create the account
# or use a pre-existing one. Possibly the right thing is to split off the
# cluster & networking terraform from the ingresss 'edge', 'iam' and 'service'
# supporting terraform. For now we create the namespaces we need to support the
# desired workload identity distinctions
#
# The current identity namespaces are:
# * traefik - dns01 challenge resolution cloud dns access
# * queth - genesis and dlt network configuration. storage bucket read/write and raft add/remove and reading node keys
# * caas - contracts layer, reading account keys (secrets)

module "workload-identity-kubeip" {
  source = "terraform-google-modules/kubernetes-engine/google//modules/workload-identity"
  version = "7.3.0"
  name = "kubeip-sa"
  namespace = "kube-system"
  project_id = var.project
}

# This namespace gets the identity that can resolve dns challenges. This
# idenity can create and delete dns records
resource "kubernetes_namespace" "traefik" {
  metadata {
    labels = { name = "traefik" }
    name = "traefik"
  }
}

# All the quorum nodes go in here. We don't segregate them further. Any node
# could potentially do genesis (writing to the storage bucket) and perform raft
# add/remove. That could be finessed. But this seems enough for a developer
# oriented setup.
resource "kubernetes_namespace" "queth" {
  metadata {
    labels = { name = "queth" }
    name = "queth"
  }
}

# Can read wallet account keys
resource "kubernetes_namespace" "caas" {
  metadata {
    labels = { name = "caas" }
    name = "caas"
  }
}

module "workload-identity-dns01solver" {
  source = "terraform-google-modules/kubernetes-engine/google//modules/workload-identity"
  version = "7.3.0"
  name = "dns01solver-sa"
  namespace = "traefik"
  project_id = var.project
}

module "quorum-genesis" {
  source = "terraform-google-modules/kubernetes-engine/google//modules/workload-identity"
  version = "7.3.0"
  name = "quorum-genesis-sa"
  namespace = "queth"
  project_id = var.project
}

module "quorum-membership" {
  source = "terraform-google-modules/kubernetes-engine/google//modules/workload-identity"
  version = "7.3.0"
  name = "quorum-membership-sa"
  namespace = "queth"
  project_id = var.project
}

module "quorum-node" {
  source = "terraform-google-modules/kubernetes-engine/google//modules/workload-identity"
  version = "7.3.0"
  name = "quorum-node-sa"
  namespace = "queth"
  project_id = var.project
}

module "quorum-client" {
  source = "terraform-google-modules/kubernetes-engine/google//modules/workload-identity"
  version = "7.3.0"
  name = "quorum-client-sa"
  namespace = "caas"
  project_id = var.project
}
