# https://taskfile.dev
version: '2'

vars:
  MAX_NODE_IDX: 2

tasks:
  deploy-crds:
    desc: re-deploy custom resource definitions if they have changed (skaffold & kubectl etal are not able to do this)
    cmds:
      - kubectl apply -f k8s/north/bases/traefik/resource.yaml
      - touch k8s/north/bases/traefik/crd-deployed
    sources:
      - k8s/north/bases/traefik/resource.yaml
    generates:
      - k8s/north/bases/traefik/crd-deployed
  deploy:
    deps: [deploy-crds]
    desc: deploy (and build if necessary)
    cmds:
      - skaffold run

  tls-sa-key:
    desc: create secret for use with cert-manager (until workload identity is supported)
    cmds:
      - |
        gcloud iam service-accounts keys create \
          key.json --iam-account dns01solver-sa@quorumpreempt.iam.gserviceaccount.com
        gcloud projects add-iam-policy-binding quorumpreempt \
          --member serviceAccount:dns01solver-sa@quorumpreempt.iam.gserviceaccount.com \
          --role roles/dns.admin

        kubectl -n cert-manager delete secret dns01solver-sa-key || true
        kubectl -n cert-manager create secret generic dns01solver-sa-key \
          --from-file key.json

  nodekeys:
    desc: ensure all node secrets exist in gcp
    cmds:
      - |
        for i in $(seq 0  {{.MAX_NODE_IDX}})
        do
          tools/secrets.sh nodekey qnode-$i-
          tools/secrets.sh wallet qnode-$i-wallet-
        done
    silent: true

  tf-import-secrets:
    desc: import secret manager secrets (not values) into terraform
    dir: cluster
    cmds:
      - |
        for i in $(seq 0 {{.MAX_NODE_IDX}}); do
          for kind in key enode wallet-address wallet-key wallet-password; do
            terraform import \
              module.cluster.google_secret_manager_secret.qnode[\"qnode-$i-$kind\"] \
              projects/quorumpreempt/secrets/qnode-$i-$kind
          done
        done
    silent: true
  tf-rmstate-secrets:
    desc: remove secret manager secret resources DOES NOT delete keys
    dir: cluster
    cmds:
      - |
        for i in $(seq 0 {{.MAX_NODE_IDX}}); do
          for kind in key enode wallet-address wallet-key wallet-password; do
          terraform state rm \
            module.cluster.google_secret_manager_secret.qnode[\"qnode-$i-$kind\"]
          done
        done
    silent: true
